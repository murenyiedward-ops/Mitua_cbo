<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitua CBO Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #1b5e20; --secondary: #2e7d32; --light: #f4f7f6; --danger: #d32f2f; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--light); color: #333; }
        
        /* LOGIN STYLING */
        #loginPage { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1531206715517-5c0ba140b2b8?auto=format&fit=crop&q=80'); background-size: cover; }
        .login-card { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; }
        .btn-main { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* DASHBOARD STYLING */
        #dashboard { display: none; }
        .header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; sticky; top:0; z-index:100; }
        .tabs { display: flex; background: var(--secondary); sticky; top: 50px; }
        .t-btn { flex: 1; padding: 15px; border: none; background: none; color: white; font-weight: bold; opacity: 0.7; }
        .t-btn.active { opacity: 1; border-bottom: 4px solid white; }
        .container { padding: 15px; max-width: 800px; margin: auto; }
        .card { background: white; padding: 15px; margin-bottom: 12px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; border-left: 5px solid var(--primary); }
        .progress-bg { background: #eee; height: 10px; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .progress-fill { background: var(--secondary); height: 100%; }
        .del-btn { color: var(--danger); background: none; border: none; font-size: 20px; cursor: pointer; }
        .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 30px; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        #chart-container { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="login-card">
            <h2 style="color: var(--primary); margin-top:0;">MITUA MASSIVE FAMILY CBO</h2>
            <p>Transparency & Tracking Portal</p>
            <input type="text" id="loginUser" placeholder="Enter Your Full Name">
            <input type="password" id="loginPass" placeholder="Password">
            <button class="btn-main" onclick="handleLogin()">LOGIN</button>
            <p style="font-size: 12px; color: #666; margin-top:15px;">Default password for members: <b>2025</b></p>
        </div>
    </div>

    <div id="dashboard">
        <div class="header">
            <div><b id="displayUser">User</b> <span id="displayRole" style="font-size:10px; opacity:0.8;"></span></div>
            <button onclick="logout()" style="background:none; border:1px solid white; color:white; border-radius:5px; padding:4px 8px;">Logout</button>
        </div>
        
        <div class="tabs">
            <button class="t-btn active" id="tabP" onclick="switchTab('proj')">PROJECTS</button>
            <button class="t-btn" id="tabM" onclick="switchTab('mem')">MEMBERS</button>
            <button class="t-btn" id="tabT" onclick="switchTab('tre')">TREASURY</button>
        </div>

        <div class="container">
            <div id="projView">
                <div id="chart-container"><canvas id="myChart"></canvas></div>
                <div id="listProjects"></div>
            </div>
            
            <div id="memView" style="display:none;">
                <button onclick="changePassword()" style="width:100%; margin-bottom:15px; padding:10px; border-radius:5px; border:1px solid var(--primary);">Set My Private Password</button>
                <div id="listMembers"></div>
            </div>

            <div id="treView" style="display:none;">
                <div id="listTreasury"></div>
            </div>
        </div>

        <button class="fab" id="adminFab" onclick="addNewData()">+</button>
    </div>

    <script>
        // CONFIGURATION
        const firebaseConfig = { apiKey: "AIzaSyDOwV2LyxvZlUSpqiqBFsTAO5CVTSBI940", authDomain: "mitua-cbo.firebaseapp.com", projectId: "mitua-cbo", storageBucket: "mitua-cbo.firebasestorage.app", messagingSenderId: "1027796270356", appId: "1:1027796270356:web:d7bb6dd472bc8038129601" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let chartObj = null;

        // LOGIN LOGIC
        async function handleLogin() {
            const user = document.getElementById('loginUser').value.trim();
            const pass = document.getElementById('loginPass').value.trim();

            if(user.toLowerCase() === "edward" && pass === "1234") {
                launchDashboard(user, "admin", "admin_id");
                return;
            }

            // Check Firebase for user and password
            const q = await db.collection("members").where("n", "==", user).get();
            if(!q.empty) {
                const data = q.docs[0].data();
                const correctPass = data.p || "2025";
                if(pass === correctPass) {
                    launchDashboard(user, "member", q.docs[0].id);
                } else { alert("Wrong Password!"); }
            } else { alert("Name not found in registry."); }
        }

        function launchDashboard(name, role, id) {
            localStorage.setItem("mName", name);
            localStorage.setItem("mRole", role);
            localStorage.setItem("mId", id);
            
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('displayUser').innerText = name;
            document.getElementById('displayRole').innerText = `(${role.toUpperCase()})`;
            
            if(role === 'admin') document.getElementById('adminFab').style.display = 'block';
            
            startListeners();
        }

        function logout() { localStorage.clear(); location.reload(); }

        // TABS
        function switchTab(type) {
            document.getElementById('projView').style.display = type==='proj'?'block':'none';
            document.getElementById('memView').style.display = type==='mem'?'block':'none';
            document.getElementById('treView').style.display = type==='tre'?'block':'none';
            document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('active'));
            if(type==='proj') document.getElementById('tabP').classList.add('active');
            if(type==='mem') document.getElementById('tabM').classList.add('active');
            if(type==='tre') document.getElementById('tabT').classList.add('active');
        }

        // DATABASE LISTENERS
        function startListeners() {
            const role = localStorage.getItem("mRole");

            // 1. Projects & Chart
            db.collection("projects").onSnapshot(snap => {
                let h = "", totalG = 0, totalR = 0;
                snap.forEach(doc => {
                    const p = doc.data();
                    const pct = Math.round((p.r/p.g)*100) || 0;
                    totalG += p.g; totalR += p.r;
                    h += `<div class="card">
                        <div style="display:flex; justify-content:space-between;"><b>${p.n}</b>
                        ${role==='admin'? `<button class="del-btn" onclick="deleteDoc('projects','${doc.id}')">üóëÔ∏è</button>` : ''}</div>
                        <div class="progress-bg"><div class="progress-fill" style="width:${pct}%"></div></div>
                        <small>Ksh ${p.r.toLocaleString()} / ${p.g.toLocaleString()} (${pct}%)</small>
                    </div>`;
                });
                document.getElementById('listProjects').innerHTML = h;
                updateChart(totalR, totalG - totalR);
            });

            // 2. Members
            db.collection("members").onSnapshot(snap => {
                let h = "";
                snap.forEach(doc => {
                    const m = doc.data();
                    h += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                        <div><b>${m.n}</b><br><small>ID: ${m.i}</small></div>
                        ${role==='admin'? `<button class="del-btn" onclick="deleteDoc('members','${doc.id}')">üóëÔ∏è</button>` : ''}
                    </div>`;
                });
                document.getElementById('listMembers').innerHTML = h;
            });

            // 3. Treasury
            db.collection("finance").onSnapshot(snap => {
                let h = "";
                snap.forEach(doc => {
                    const f = doc.data();
                    h += `<div class="card">
                        <div style="display:flex; justify-content:space-between;"><b>${f.n}</b>
                        ${role==='admin'? `<button class="del-btn" onclick="deleteDoc('finance','${doc.id}')">üóëÔ∏è</button>` : ''}</div>
                        Ksh ${f.a.toLocaleString()} - ${f.r}
                    </div>`;
                });
                document.getElementById('listTreasury').innerHTML = h;
            });
        }

        // ACTIONS
        function deleteDoc(col, id) { if(confirm("Confirm Delete?")) db.collection(col).doc(id).delete(); }

        function addNewData() {
            const activeTab = document.querySelector('.t-btn.active').innerText;
            if(activeTab === 'PROJECTS') {
                let n=prompt("Project Name:"), g=prompt("Goal:"), r=prompt("Raised:");
                if(n) db.collection("projects").add({n, g:Number(g), r:Number(r), ts:Date.now()});
            } else if(activeTab === 'MEMBERS') {
                let n=prompt("Full Name:"), i=prompt("ID No:");
                if(n) db.collection("members").add({n, i, p:"2025", ts:Date.now()});
            } else {
                let n=prompt("Name:"), a=prompt("Amount:"), r=prompt("Reason:");
                if(n) db.collection("finance").add({n, a:Number(a), r, ts:Date.now()});
            }
        }

        function changePassword() {
            const newP = prompt("Enter your new private password:");
            const id = localStorage.getItem("mId");
            if(newP && id !== "admin_id") {
                db.collection("members").doc(id).update({p: newP})
                .then(() => alert("Success!"));
            }
        }

        function updateChart(r, rem) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if(chartObj) chartObj.destroy();
            chartObj = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['Raised', 'Remaining'], datasets: [{ data: [r, rem < 0 ? 0 : rem], backgroundColor: ['#1b5e20', '#eee'] }] },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }
    </script>
</body>
</html>
