<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitua CBO Master Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #1b5e20; --secondary: #2e7d32; --light: #f4f7f6; --danger: #d32f2f; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--light); color: #333; }
        
        /* LOGIN SCREEN */
        #loginPage { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?auto=format&fit=crop&q=80'); background-size: cover; background-position: center; }
        .login-card { background: var(--white); padding: 40px 30px; border-radius: 20px; width: 90%; max-width: 380px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.3); }
        .login-card h2 { color: var(--primary); margin-bottom: 5px; }
        input { width: 100%; padding: 14px; margin: 12px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        .btn-login { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 16px; }
        .btn-login:hover { background: var(--secondary); }

        /* DASHBOARD SCREEN */
        #dashboard { display: none; }
        .nav-bar { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-bar { display: flex; background: var(--secondary); position: sticky; top: 56px; z-index: 999; }
        .tab-item { flex: 1; padding: 15px; text-align: center; color: white; cursor: pointer; font-weight: bold; opacity: 0.7; transition: 0.3s; border-bottom: 4px solid transparent; }
        .tab-item.active { opacity: 1; border-bottom: 4px solid white; }
        
        .content { padding: 20px; max-width: 900px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; border-left: 6px solid var(--primary); }
        .card h4 { margin: 0 0 10px 0; color: var(--primary); }
        
        /* PROGRESS BAR */
        .prog-container { background: #eee; height: 12px; border-radius: 6px; margin: 15px 0 5px; overflow: hidden; }
        .prog-bar { height: 100%; background: var(--secondary); border-radius: 6px; transition: width 0.5s ease-in-out; }
        
        /* ADMIN TOOLS */
        .del-btn { color: var(--danger); background: none; border: none; font-size: 22px; cursor: pointer; position: absolute; top: 15px; right: 15px; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 35px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none; cursor: pointer; z-index: 1001; }
        
        #chart-box { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; text-align: center; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="login-card">
            <h2>MITUA CBO</h2>
            <p style="color: #666; margin-bottom: 20px;">Secure Management Portal</p>
            <input type="text" id="userIn" placeholder="Enter Registered Name">
            <input type="password" id="passIn" placeholder="Password">
            <button class="btn-login" onclick="secureLogin()">ENTER PORTAL</button>
            <p id="errorMsg" style="color: red; font-size: 13px; margin-top: 10px; display: none;">Access Denied</p>
        </div>
    </div>

    <div id="dashboard">
        <div class="nav-bar">
            <span><b>Mitua CBO</b> | <span id="helloUser">User</span></span>
            <button onclick="logout()" style="background:transparent; border:1px solid white; color:white; border-radius:5px; padding:5px 10px; cursor:pointer;">Logout</button>
        </div>
        
        <div class="tab-bar">
            <div class="tab-item active" id="tP" onclick="openTab('projects')">PROJECTS</div>
            <div class="tab-item" id="tM" onclick="openTab('members')">MEMBERS</div>
            <div class="tab-item" id="tF" onclick="openTab('finance')">TREASURY</div>
        </div>

        <div class="content">
            <div id="viewProjects">
                <div id="chart-box"><canvas id="mainChart"></canvas></div>
                <div id="projectList"></div>
            </div>

            <div id="viewMembers" style="display:none;">
                <div style="background:white; padding:15px; border-radius:10px; margin-bottom:15px; border:1px dashed var(--primary);">
                    <p style="margin:0; font-size:14px;">Want a private password? Log in and click:</p>
                    <button onclick="updateMyPassword()" style="margin-top:10px; background:var(--secondary); color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">Set Private Password</button>
                </div>
                <div id="memberList"></div>
            </div>

            <div id="viewFinance" style="display:none;">
                <div id="financeList"></div>
            </div>
        </div>

        <button class="fab" id="addBtn" onclick="handleFabClick()">+</button>
    </div>

    <script>
        // FIREBASE SETUP
        const firebaseConfig = { apiKey: "AIzaSyDOwV2LyxvZlUSpqiqBFsTAO5CVTSBI940", authDomain: "mitua-cbo.firebaseapp.com", projectId: "mitua-cbo", storageBucket: "mitua-cbo.firebasestorage.app", messagingSenderId: "1027796270356", appId: "1:1027796270356:web:d7bb6dd472bc8038129601" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let myChart = null;

        // AUTHENTICATION LOGIC
        async function secureLogin() {
            const user = document.getElementById('userIn').value.trim();
            const pass = document.getElementById('passIn').value.trim();
            const error = document.getElementById('errorMsg');

            if (user.toLowerCase() === "edward" && pass === "1234") {
                startSession(user, "admin", "admin_id");
                return;
            }

            // WHITELIST CHECK: Check if the name exists in the database
            try {
                const query = await db.collection("members").where("n", "==", user).get();
                if (query.empty) {
                    error.innerText = "Access Denied: Name not in CBO Registry.";
                    error.style.display = "block";
                    return;
                }

                const doc = query.docs[0];
                const data = doc.data();
                const validPass = data.p || "2025"; // Default is 2025

                if (pass === validPass) {
                    startSession(user, "member", doc.id);
                } else {
                    error.innerText = "Incorrect Password.";
                    error.style.display = "block";
                }
            } catch (e) { alert("Network Error. Check internet."); }
        }

        function startSession(name, role, id) {
            localStorage.setItem("cboUser", name);
            localStorage.setItem("cboRole", role);
            localStorage.setItem("cboId", id);
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('helloUser').innerText = name;
            if(role === 'admin') document.getElementById('addBtn').style.display = 'block';
            loadData();
        }

        function logout() { localStorage.clear(); location.reload(); }

        // NAVIGATION
        function openTab(tab) {
            document.getElementById('viewProjects').style.display = tab==='projects'?'block':'none';
            document.getElementById('viewMembers').style.display = tab==='members'?'block':'none';
            document.getElementById('viewFinance').style.display = tab==='finance'?'block':'none';
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            if(tab==='projects') document.getElementById('tP').classList.add('active');
            if(tab==='members') document.getElementById('tM').classList.add('active');
            if(tab==='finance') document.getElementById('tF').classList.add('active');
        }

        // DATA LOADING
        function loadData() {
            const role = localStorage.getItem("cboRole");

            // PROJECTS
            db.collection("projects").orderBy("ts", "desc").onSnapshot(snap => {
                let html = "", tG = 0, tR = 0;
                snap.forEach(doc => {
                    const p = doc.data();
                    const pct = Math.min(100, Math.round((p.r/p.g)*100)) || 0;
                    tG += p.g; tR += p.r;
                    html += `<div class="card">
                        <h4>${p.n}</h4>
                        ${role==='admin' ? `<button class="del-btn" onclick="removeItem('projects','${doc.id}')">üóëÔ∏è</button>`:''}
                        <div class="prog-container"><div class="prog-bar" style="width:${pct}%"></div></div>
                        <small>Ksh ${p.r.toLocaleString()} / ${p.g.toLocaleString()} (${pct}%)</small>
                    </div>`;
                });
                document.getElementById('projectList').innerHTML = html;
                drawChart(tR, (tG - tR));
            });

            // MEMBERS
            db.collection("members").orderBy("n", "asc").onSnapshot(snap => {
                let html = "";
                snap.forEach(doc => {
                    const m = doc.data();
                    html += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                        <div><b>${m.n}</b><br><small>Member ID: ${m.i}</small></div>
                        ${role==='admin' ? `<button class="del-btn" onclick="removeItem('members','${doc.id}')">üóëÔ∏è</button>`:''}
                    </div>`;
                });
                document.getElementById('memberList').innerHTML = html;
            });

            // FINANCE
            db.collection("finance").orderBy("ts", "desc").onSnapshot(snap => {
                let html = "";
                snap.forEach(doc => {
                    const f = doc.data();
                    html += `<div class="card">
                        <h4>Ksh ${f.a.toLocaleString()}</h4>
                        ${role==='admin' ? `<button class="del-btn" onclick="removeItem('finance','${doc.id}')">üóëÔ∏è</button>`:''}
                        <p style="margin:0;">By: ${f.n} | Reason: ${f.r}</p>
                    </div>`;
                });
                document.getElementById('financeList').innerHTML = html;
            });
        }

        // DATABASE OPERATIONS
        function removeItem(col, id) { if(confirm("Permanently delete this?")) db.collection(col).doc(id).delete(); }

        function handleFabClick() {
            const active = document.querySelector('.tab-item.active').innerText;
            if(active === 'PROJECTS') {
                let n=prompt("Project Title:"), g=prompt("Goal (Ksh):"), r=prompt("Current Raised (Ksh):");
                if(n) db.collection("projects").add({n, g:Number(g), r:Number(r), ts:Date.now()});
            } else if(active === 'MEMBERS') {
                let n=prompt("Full Name:"), i=prompt("ID Number:");
                if(n) db.collection("members").add({n, i, p:"2025", ts:Date.now()});
            } else {
                let n=prompt("Payer/Recipient:"), a=prompt("Amount (Ksh):"), r=prompt("Description:");
                if(n) db.collection("finance").add({n, a:Number(a), r, ts:Date.now()});
            }
        }

        function updateMyPassword() {
            const newP = prompt("Create your new secret password:");
            const mid = localStorage.getItem("cboId");
            if(newP && mid && mid !== 'admin_id') {
                db.collection("members").doc(mid).update({p: newP}).then(() => alert("Password Updated!"));
            }
        }

        function drawChart(r, rem) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['Raised Total', 'Remaining Goal'], datasets: [{ data: [r, rem < 0 ? 0 : rem], backgroundColor: ['#1b5e20', '#e0e0e0'] }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }
    </script>
</body>
</html>
